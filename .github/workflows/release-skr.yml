name: release-skr

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to build (e.g. v1.2.3 or refs/tags/v1.2.3)"
        required: true
        type: string
      registry:
        description: "Optional ACR login server override (e.g. myregistry.azurecr.io). If empty, uses REGISTRY from cacitesting.env"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  id-token: write

jobs:
  build_sign_push:
    name: Build + sign + push SKR image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      # needed to avoid a bug where imageId and digest output are the same
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: v0.18.0

      - name: Resolve build metadata (tag, commit, workflow)
        shell: bash
        run: |
          set -euo pipefail

          RAW_TAG='${{ inputs.tag }}'
          IMAGE_TAG="${RAW_TAG#refs/tags/}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"

          SOURCE_SHA="$(git rev-parse HEAD)"
          echo "SOURCE_SHA=$SOURCE_SHA" >> "$GITHUB_ENV"

          # Try to resolve the exact tag name from the checked-out commit
          if git describe --tags --exact-match >/dev/null 2>&1; then
            EXACT_TAG="$(git describe --tags --exact-match)"
            echo "EXACT_TAG=$EXACT_TAG" >> "$GITHUB_ENV"
          else
            echo "EXACT_TAG=" >> "$GITHUB_ENV"
          fi

          echo "SOURCE_REPO=${GITHUB_REPOSITORY}" >> "$GITHUB_ENV"
          echo "SOURCE_REPO_URL=https://github.com/${GITHUB_REPOSITORY}" >> "$GITHUB_ENV"
          echo "WORKFLOW_REF=${GITHUB_WORKFLOW_REF}" >> "$GITHUB_ENV"
          echo "WORKFLOW_SHA=${GITHUB_SHA}" >> "$GITHUB_ENV"
          echo "WORKFLOW_NAME=${GITHUB_WORKFLOW}" >> "$GITHUB_ENV"
          echo "WORKFLOW_PATH=${GITHUB_WORKFLOW_REF%@*}" >> "$GITHUB_ENV"

      - name: Log in to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MANAGED_ID_CLIENT_ID }}
          tenant-id: ${{ secrets.MANAGED_ID_TENANT_ID }}
          subscription-id: ${{ vars.SUBSCRIPTION }}

      - name: Log in to Azure Container Registry (ACR)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.registry }}" ]]; then
            REGISTRY="${{ inputs.registry }}"
          else
            source cacitesting.env
          fi
          echo "REGISTRY=$REGISTRY" >> "$GITHUB_ENV"
          az acr login --name "$REGISTRY"

      - name: Build and push SKR image
        uses: docker/build-push-action@v6
        id: build
        with:
          context: ./
          file: docker/skr/Dockerfile.skr
          push: true
          tags: |
            ${{ env.REGISTRY }}/skr:${{ env.IMAGE_TAG }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Cosign sign (keyless/OIDC) + attach build metadata
        shell: bash
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail

          IMAGE_DIGEST='${{ steps.build.outputs.digest }}'
          IMAGE="${REGISTRY}/skr@${IMAGE_DIGEST}"

          cosign version

          # Sign the immutable digest reference and include the source commit + workflow identity as annotations.
          cosign sign \
            -a "source_repo=${SOURCE_REPO}" \
            -a "source_repo_url=${SOURCE_REPO_URL}" \
            -a "source_commit=${SOURCE_SHA}" \
            -a "source_tag_input=${{ inputs.tag }}" \
            -a "source_tag_exact=${EXACT_TAG}" \
            -a "workflow_name=${WORKFLOW_NAME}" \
            -a "workflow_ref=${WORKFLOW_REF}" \
            -a "workflow_sha=${WORKFLOW_SHA}" \
            -a "run_id=${GITHUB_RUN_ID}" \
            -a "run_attempt=${GITHUB_RUN_ATTEMPT}" \
            "$IMAGE"

      - name: Cosign attest (keyless/OIDC) with explicit provenance predicate
        shell: bash
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail

          IMAGE_DIGEST='${{ steps.build.outputs.digest }}'
          IMAGE="${REGISTRY}/skr@${IMAGE_DIGEST}"

          cat > predicate.json <<'JSON'
          {
            "buildType": "github-actions-release-skr",
            "source": {
              "repository": "__SOURCE_REPO__",
              "repositoryUrl": "__SOURCE_REPO_URL__",
              "tagInput": "__TAG_INPUT__",
              "tagExact": "__TAG_EXACT__",
              "commit": "__SOURCE_SHA__"
            },
            "workflow": {
              "name": "__WORKFLOW_NAME__",
              "ref": "__WORKFLOW_REF__",
              "sha": "__WORKFLOW_SHA__",
              "path": "__WORKFLOW_PATH__",
              "runId": "__RUN_ID__",
              "runAttempt": "__RUN_ATTEMPT__"
            },
            "image": {
              "name": "__REGISTRY__/skr",
              "digest": "__IMAGE_DIGEST__"
            }
          }
          JSON

          # Fill in placeholders without relying on non-portable JSON tooling.
          sed -i \
            -e "s|__SOURCE_REPO__|${SOURCE_REPO}|g" \
            -e "s|__SOURCE_REPO_URL__|${SOURCE_REPO_URL}|g" \
            -e "s|__TAG_INPUT__|${{ inputs.tag }}|g" \
            -e "s|__TAG_EXACT__|${EXACT_TAG}|g" \
            -e "s|__SOURCE_SHA__|${SOURCE_SHA}|g" \
            -e "s|__WORKFLOW_NAME__|${WORKFLOW_NAME}|g" \
            -e "s|__WORKFLOW_REF__|${WORKFLOW_REF}|g" \
            -e "s|__WORKFLOW_SHA__|${WORKFLOW_SHA}|g" \
            -e "s|__WORKFLOW_PATH__|${WORKFLOW_PATH}|g" \
            -e "s|__RUN_ID__|${GITHUB_RUN_ID}|g" \
            -e "s|__RUN_ATTEMPT__|${GITHUB_RUN_ATTEMPT}|g" \
            -e "s|__REGISTRY__|${REGISTRY}|g" \
            -e "s|__IMAGE_DIGEST__|${IMAGE_DIGEST}|g" \
            predicate.json

          # Attest the immutable digest reference. The attestation signature is bound to the GitHub Actions OIDC identity,
          # while the predicate records the checked-out tag commit.
          cosign attest \
            --type slsaprovenance \
            --predicate predicate.json \
            "$IMAGE"


